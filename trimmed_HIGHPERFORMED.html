<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Video Splitter ‚Äî Optimized (No Freeze)</title>
<style>
:root{--bg:#0b1020;--card:#0f1724;--accent:#7c3aed;--accent-light:#8b5cf6;--success:#10b981;--warning:#f59e0b;--muted:#9aa4b2;--glass:rgba(255,255,255,0.03)}
*{box-sizing:border-box}
body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:linear-gradient(180deg,#05060a 0%, #0b1020 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.wrap{width:980px;max-width:96%;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
h1{margin:0 0 8px;font-size:20px}
p.lead{margin:0 0 18px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:14px;border-radius:10px}
input[type=file]{color:transparent}
.video-wrap{display:flex;flex-direction:column;gap:12px}
video{width:100%;border-radius:8px;background:#000;max-height:420px}
label.small{display:inline-block;font-size:12px;color:var(--muted);margin-bottom:6px}
/* Upload Methods Tabs */
.upload-tabs{display:flex;border-bottom:1px solid rgba(255,255,255,0.05);margin-bottom:12px}
.tab-btn{background:transparent;border:none;color:var(--muted);padding:8px 16px;cursor:pointer;font-size:13px;position:relative}
.tab-btn:hover{color:white}
.tab-btn.active{color:var(--accent)}
.tab-btn.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:var(--accent)}
.tab-content{display:none}
.tab-content.active{display:block}
.link-input-container{display:flex;gap:8px;margin-top:8px}
.link-input{flex:1;padding:10px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:8px;color:white;font-size:13px}
.link-input:focus{outline:none;border-color:var(--accent)}
.link-help{font-size:11px;color:var(--muted);margin-top:4px}
.link-help a{color:var(--accent);text-decoration:none}
.link-help a:hover{text-decoration:underline}
/* Enhanced Controls */
.controls-container{display:flex;flex-direction:column;gap:12px}
.playback-controls{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
.time-navigation{display:flex;align-items:center;gap:6px}
.nav-btn{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted);width:30px;height:30px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px}
.nav-btn:hover{background:rgba(255,255,255,0.05);border-color:var(--accent);color:white}
.jump-btn{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:4px 8px;border-radius:6px;cursor:pointer;font-size:11px}
.jump-btn:hover{background:rgba(124,58,237,0.1);border-color:var(--accent);color:white}
.set-time-btn{background:rgba(124,58,237,0.15);border:1px solid var(--accent);color:white;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500}
.set-time-btn:hover{background:rgba(124,58,237,0.25)}
.time-display{font-family:'JetBrains Mono','Cascadia Code',monospace;font-size:13px;color:white;background:rgba(0,0,0,0.3);padding:4px 8px;border-radius:4px;min-width:80px;text-align:center}
.range-controls{display:flex;flex-direction:column;gap:14px;background:rgba(255,255,255,0.02);padding:14px;border-radius:8px}
.range-group{display:flex;align-items:center;gap:12px}
.range-label{font-size:13px;color:var(--muted);min-width:60px}
.range-wrapper{flex:1;display:flex;align-items:center;gap:10px}
input[type=range]{flex:1;height:6px;border-radius:3px;background:rgba(255,255,255,0.1);outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}
input[type=range]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--accent);border:none;cursor:pointer}
.time-input{width:70px;padding:6px 8px;background:transparent;border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:white;font-family:monospace;font-size:13px}
.time-input:focus{outline:none;border-color:var(--accent)}
.action-buttons{display:flex;gap:8px;align-items:center;justify-content:space-between}
.btn{background:var(--accent);border:none;padding:10px 16px;border-radius:8px;color:white;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:6px}
.btn:hover{background:var(--accent-light)}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.1)}
.btn.secondary:hover{background:rgba(255,255,255,0.05);border-color:var(--accent)}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.duration-badge{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--glass);color:var(--muted);display:flex;align-items:center;gap:4px}
.duration-badge .highlight{color:white;font-weight:600}
.sidebar{display:flex;flex-direction:column;gap:12px}
.field{display:flex;flex-direction:column;gap:6px}
.smallmuted{font-size:13px;color:var(--muted)}
.download-list{display:flex;flex-direction:column;gap:8px}
a.download{display:inline-block;padding:8px 10px;background:linear-gradient(90deg, rgba(255,255,255,0.03), transparent);border-radius:8px;color:#cfe9ff;text-decoration:none;display:flex;justify-content:space-between;align-items:center}
a.download:hover{background:linear-gradient(90deg, rgba(255,255,255,0.06), transparent)}
footer.note{margin-top:12px;font-size:12px;color:var(--muted)}
progress{width:100%;height:8px;border-radius:4px;background:rgba(255,255,255,0.1);border:none}
progress::-webkit-progress-bar{background:rgba(255,255,255,0.1);border-radius:4px}
progress::-webkit-progress-value{background:var(--accent);border-radius:4px}
progress::-moz-progress-bar{background:var(--accent);border-radius:4px}
.keyboard-hint{font-size:11px;color:var(--muted);margin-top:2px}
.keyboard-key{display:inline-block;padding:1px 4px;background:rgba(255,255,255,0.1);border-radius:3px;font-family:monospace;font-size:10px;margin:0 1px}
.segment-indicator{height:4px;background:rgba(124,58,237,0.3);border-radius:2px;position:relative;margin:4px 0}
.segment-indicator::before{content:'';position:absolute;left:0;width:var(--start-percent);height:100%;background:transparent}
.segment-indicator::after{content:'';position:absolute;left:var(--start-percent);width:calc(var(--end-percent) - var(--start-percent));height:100%;background:var(--accent);border-radius:2px}
/* Percentage indicators */
.percentage-display{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent);background:rgba(124,58,237,0.1);padding:2px 6px;border-radius:4px;min-width:50px;text-align:center}
.percentage-label{font-size:11px;color:var(--muted);margin-top:2px}
.progress-info{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}
.time-with-percent{display:flex;flex-direction:column;align-items:center;gap:2px}
.range-with-percent{display:flex;align-items:center;gap:8px;width:100%}
.percent-input-group{display:flex;align-items:center;gap:6px;margin-top:4px}
.percent-input{width:60px;padding:4px 6px;background:transparent;border:1px solid rgba(255,255,255,0.08);border-radius:4px;color:white;font-size:12px;text-align:center}
.percent-input:focus{outline:none;border-color:var(--accent)}
.export-progress-info{display:flex;justify-content:space-between;margin-top:6px;font-size:12px}
.export-progress-percent{color:var(--accent);font-weight:600}
.export-progress-time{color:var(--muted)}
/* Audio controls */
.audio-status{background:rgba(16,185,129,0.1);color:var(--success);border:1px solid rgba(16,185,129,0.3);padding:4px 8px;border-radius:6px;font-size:11px;display:inline-flex;align-items:center;gap:4px}
.audio-status.muted{background:rgba(156,163,175,0.1);color:var(--muted);}
.audio-status.error{background:rgba(239,68,68,0.1);color:#ef4444;}
.file-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.file-size{font-size:12px;color:var(--muted)}
/* Captions Panel */
.captions-container{margin-top:12px}
.captions-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.captions-header h3{font-size:14px;margin:0;color:var(--muted)}
.captions-controls{display:flex;gap:6px}
.captions-panel{background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;max-height:200px;overflow-y:auto}
.caption-line{margin-bottom:8px;padding:6px 8px;background:rgba(255,255,255,0.03);border-radius:4px;font-size:12px}
.caption-time{font-family:monospace;color:var(--accent);font-size:11px;margin-right:8px}
.caption-text{color:white}
.no-captions{text-align:center;color:var(--muted);font-size:12px;padding:20px}
/* Volume controls */
.volume-controls{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.volume-slider-container{display:flex;align-items:center;gap:10px}
.volume-slider{flex:1;height:6px;border-radius:3px;background:rgba(255,255,255,0.1);outline:none}
.volume-slider::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer}
.volume-slider::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--accent);border:none;cursor:pointer}
.volume-value{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent);min-width:40px;text-align:center}
.volume-presets{display:flex;gap:6px;margin-top:4px}
.volume-preset{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px}
.volume-preset:hover{background:rgba(124,58,237,0.1);border-color:var(--accent);color:white}
.volume-preset.active{background:var(--accent);border-color:var(--accent);color:white}
.volume-visualizer{height:4px;border-radius:2px;background:linear-gradient(90deg, var(--accent) 0%, var(--accent) var(--volume-percent, 100%), rgba(255,255,255,0.1) var(--volume-percent, 100%))}
.volume-label{display:flex;justify-content:space-between;align-items:center}
.volume-label span:last-child{font-size:11px;color:var(--muted)}
/* Performance optimizations */
.performance-notice{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:6px;padding:6px 10px;font-size:11px;color:var(--warning);display:block;margin-top:6px}
/* Smooth video styling */
.video-container{position:relative}
.video-container::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(to bottom, transparent 50%, rgba(0,0,0,0.1) 100%);border-radius:8px;pointer-events:none}
video.smooth{-webkit-backface-visibility:hidden;-webkit-transform:translateZ(0) scale(1.0, 1.0);transform:translateZ(0);will-change:transform}
/* Speed controls */
.speed-controls{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.speed-slider-container{display:flex;align-items:center;gap:10px}
.speed-slider{flex:1;height:6px;border-radius:3px;background:rgba(255,255,255,0.1);outline:none}
.speed-slider::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);cursor:pointer}
.speed-slider::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--accent);border:none;cursor:pointer}
.speed-value{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent);min-width:40px;text-align:center}
.speed-presets{display:flex;gap:6px;margin-top:4px}
.speed-preset{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--muted);padding:3px 8px;border-radius:4px;cursor:pointer;font-size:10px}
.speed-preset:hover{background:rgba(124,58,237,0.1);border-color:var(--accent);color:white}
.speed-preset.active{background:var(--accent);border-color:var(--accent);color:white}
.speed-visualizer{height:4px;border-radius:2px;background:linear-gradient(90deg, var(--accent) 0%, var(--accent) var(--speed-percent, 100%), rgba(255,255,255,0.1) var(--speed-percent, 100%))}
.speed-label{display:flex;justify-content:space-between;align-items:center}
.speed-label span:last-child{font-size:11px;color:var(--muted)}
/* Playback speed indicator */
.speed-indicator{position:absolute;top:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;z-index:10}
@media (max-width:880px){.grid{grid-template-columns:1fr}}
@media (max-width:600px){
.playback-controls{flex-wrap:wrap}
.range-group{flex-direction:column;align-items:stretch}
.range-label{width:100%}
.range-with-percent{flex-direction:column;align-items:stretch}
}
</style>
</head>
<body>
<div class="wrap" role="application">
<h1>üé¨ Video Splitter ‚Äî Optimized (No Freeze)</h1>
<p class="lead">‚úÖ Frame throttling, hardware acceleration, buffering ‚Äî all ON by default.</p>
<div class="grid">
<div class="panel">
<div class="video-wrap">
<div class="file-info">
<label class="small">Upload Method</label>
<div class="file-size" id="fileSizeInfo"></div>
</div>
<!-- Upload Tabs -->
<div class="upload-tabs">
<button class="tab-btn active" data-tab="file-tab">üìÅ File Upload</button>
<button class="tab-btn" data-tab="link-tab">üîó Video Link</button>
</div>
<!-- File Upload Tab -->
<div id="file-tab" class="tab-content active">
<input id="fileInput" type="file" accept="video/*">
<div class="link-help">
Supports MP4, WebM, MOV, AVI, MKV, etc. (Max 1GB recommended for smooth export)
</div>
</div>
<!-- Link Upload Tab -->
<div id="link-tab" class="tab-content">
<div class="link-input-container">
<input type="url" id="videoLink" class="link-input" placeholder="https://example.com/video.mp4">
<button id="loadLinkBtn" class="btn secondary">Load</button>
</div>
<div class="link-help">
Enter direct video link (ends with .mp4, .webm, etc.)<br>
<strong>‚ö†Ô∏è Social media (YouTube, TikTok) won‚Äôt work ‚Äî use file upload.</strong>
</div>
</div>
<div id="audioStatus" class="audio-status" style="display:none;">
üîä Audio: Ready
</div>
<!-- Performance notice ‚Äî now always visible as reminder -->
<div class="performance-notice">
‚ö° <strong>Optimizations Active:</strong> Frame throttling (30 FPS), Hardware accel, 720p resize, buffering.
</div>
<div class="video-container">
<video id="player" controls preload="auto" crossorigin="anonymous" playsinline>Your browser doesn't support the video element.</video>
<div id="speedIndicator" class="speed-indicator">1.0x</div>
</div>
<div class="controls-container">
<!-- Playback Controls -->
<div class="playback-controls">
<div class="time-with-percent">
<div class="time-display" id="currentTimeDisplay">0:00</div>
<div class="percentage-display" id="currentPercentDisplay">0%</div>
</div>
<div class="time-navigation">
<button class="nav-btn" id="jumpBack5" title="Jump back 5 seconds">-5s</button>
<button class="nav-btn" id="frameBack" title="Previous frame (‚Üê)">‚èÆ</button>
<button class="nav-btn" id="playPause" title="Play/Pause (Space)">‚ñ∂</button>
<button class="nav-btn" id="frameForward" title="Next frame (‚Üí)">‚è≠</button>
<button class="nav-btn" id="jumpForward5" title="Jump forward 5 seconds">+5s</button>
</div>
<div style="display:flex;gap:6px;margin-left:auto">
<button class="set-time-btn" id="setStartBtn" title="Set start to current time (S)">Set Start</button>
<button class="set-time-btn" id="setEndBtn" title="Set end to current time (E)">Set End</button>
</div>
</div>
<div class="keyboard-hint">
Shortcuts: <span class="keyboard-key">Space</span> Play/Pause ‚Ä¢
<span class="keyboard-key">‚Üê</span> <span class="keyboard-key">‚Üí</span> Frame step ‚Ä¢
<span class="keyboard-key">S</span> Set start ‚Ä¢
<span class="keyboard-key">E</span> Set end ‚Ä¢
<span class="keyboard-key">[</span> <span class="keyboard-key">]</span> Speed
</div>
<!-- Segment Indicator -->
<div class="segment-indicator" id="segmentIndicator"></div>
<div class="progress-info">
<span>Start: <span id="startPercentText">0%</span></span>
<span>Segment: <span id="segmentPercentText">0%</span></span>
<span>End: <span id="endPercentText">0%</span></span>
</div>
<!-- Range Controls -->
<div class="range-controls">
<div class="range-group">
<span class="range-label">Start:</span>
<div class="range-wrapper">
<div class="range-with-percent">
<input id="startRange" type="range" min="0" max="0" step="0.001" value="0">
<div class="time-with-percent">
<input id="startInput" type="text" class="time-input" placeholder="0:00">
<div class="percentage-display" id="startPercentDisplay">0%</div>
</div>
</div>
</div>
</div>
<div class="range-group">
<span class="range-label">End:</span>
<div class="range-wrapper">
<div class="range-with-percent">
<input id="endRange" type="range" min="0" max="0" step="0.001" value="0">
<div class="time-with-percent">
<input id="endInput" type="text" class="time-input" placeholder="0:00">
<div class="percentage-display" id="endPercentDisplay">0%</div>
</div>
</div>
</div>
</div>
<!-- Percentage Input -->
<div class="field">
<label class="smallmuted">Set by Percentage</label>
<div class="percent-input-group">
<input id="startPercentInput" type="number" class="percent-input" placeholder="Start %" min="0" max="100" step="0.1" value="0">
<span class="smallmuted">‚Üí</span>
<input id="endPercentInput" type="number" class="percent-input" placeholder="End %" min="0" max="100" step="0.1" value="100">
<button id="applyPercentBtn" class="jump-btn">Apply %</button>
</div>
</div>
</div>
<!-- Playback Speed Control -->
<div class="speed-controls">
<div class="speed-label">
<span>‚è© Playback Speed</span>
<span id="speedPercent">1.0x</span>
</div>
<div class="speed-slider-container">
<span style="color:var(--muted);font-size:12px;">0.5x</span>
<input type="range" id="speedSlider" class="speed-slider" min="25" max="400" value="100" step="25">
<span style="color:var(--muted);font-size:12px;">4.0x</span>
<div class="speed-value" id="speedValue">1.0x</div>
</div>
<div class="speed-visualizer" id="speedVisualizer"></div>
<div class="speed-presets">
<button class="speed-preset" data-speed="25">0.25x</button>
<button class="speed-preset" data-speed="50">0.5x</button>
<button class="speed-preset active" data-speed="100">1.0x</button>
<button class="speed-preset" data-speed="150">1.5x</button>
<button class="speed-preset" data-speed="200">2.0x</button>
<button class="speed-preset" data-speed="300">3.0x</button>
<button class="speed-preset" data-speed="400">4.0x</button>
</div>
</div>
<!-- Captions Panel -->
<div class="captions-container">
<div class="captions-header">
<h3>üé§ Auto-Generated Captions</h3>
<div class="captions-controls">
<button id="generateCaptionsBtn" class="jump-btn">Generate</button>
<button id="clearCaptionsBtn" class="jump-btn">Clear</button>
<button id="exportCaptionsBtn" class="jump-btn">Export SRT</button>
</div>
</div>
<div class="captions-panel" id="captionsPanel">
<div class="no-captions">No captions generated yet. Click "Generate" to create captions from audio.</div>
</div>
</div>
<!-- Action Buttons -->
<div class="action-buttons">
<div style="display:flex;gap:8px">
<button id="previewBtn" class="btn secondary">
<span>üîç</span> Preview
</button>
<button id="trimBtn" class="btn">
<span>‚úÇÔ∏è</span> Export Video
</button>
</div>
<div class="duration-badge">
<span>Segment:</span>
<span class="highlight" id="segmentDuration">0.00s</span>
<span>|</span>
<span class="highlight" id="segmentPercent">0%</span>
<span>| Total:</span>
<span class="highlight" id="durationBadge">0s</span>
</div>
</div>
<progress id="progress" value="0" max="1" style="display:none"></progress>
<div class="export-progress-info" style="display:none" id="exportProgressInfo">
<span class="export-progress-percent" id="exportProgressPercent">0%</span>
<span class="export-progress-time" id="exportProgressTime">0:00 / 0:00</span>
</div>
<div id="errorMessage" class="smallmuted" style="color:#ef4444;margin-top:8px;display:none"></div>
<div id="status" class="smallmuted" style="margin-top:8px">No video loaded.</div>
</div>
</div>
</div>
<aside class="sidebar">
<div class="panel">
<div class="field">
<label class="smallmuted">Manual time entry</label>
<div style="display:flex;gap:6px">
<input id="manualStart" type="text" placeholder="0:00" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
<input id="manualEnd" type="text" placeholder="0:00" style="flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
</div>
<button id="applyManualTimes" class="jump-btn" style="margin-top:6px;width:100%">Apply Manual Times</button>
</div>
<div class="field">
<label class="smallmuted">Quick Jumps</label>
<div style="display:flex;gap:6px;flex-wrap:wrap">
<button class="jump-btn" data-seconds="-10">-10s</button>
<button class="jump-btn" data-seconds="-5">-5s</button>
<button class="jump-btn" data-seconds="-1">-1s</button>
<button class="jump-btn" data-seconds="1">+1s</button>
<button class="jump-btn" data-seconds="5">+5s</button>
<button class="jump-btn" data-seconds="10">+10s</button>
</div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px">
<button class="jump-btn" data-percent="-10">-10%</button>
<button class="jump-btn" data-percent="-5">-5%</button>
<button class="jump-btn" data-percent="5">+5%</button>
<button class="jump-btn" data-percent="10">+10%</button>
</div>
</div>
<div class="field">
<label class="smallmuted">Audio Settings</label>
<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;gap:6px;align-items:center">
<input id="muteCheckbox" type="checkbox">
<span class="smallmuted">Mute audio in export</span>
</label>
<!-- Volume Control -->
<div class="volume-controls">
<div class="volume-label">
<span>üîä Export Volume</span>
<span id="volumePercent">150%</span>
</div>
<div class="volume-slider-container">
<span style="color:var(--muted);font-size:12px;">Low</span>
<input type="range" id="volumeSlider" class="volume-slider" min="0" max="300" value="150" step="1">
<span style="color:var(--muted);font-size:12px;">Loud</span>
<div class="volume-value" id="volumeValue">1.5x</div>
</div>
<div class="volume-visualizer" id="volumeVisualizer"></div>
<div class="volume-presets">
<button class="volume-preset" data-volume="50">0.5x</button>
<button class="volume-preset" data-volume="100">1.0x</button>
<button class="volume-preset active" data-volume="150">1.5x</button>
<button class="volume-preset" data-volume="200">2.0x</button>
<button class="volume-preset" data-volume="300">3.0x</button>
</div>
</div>
<label style="display:flex;gap:6px;align-items:center;margin-top:8px">
<input id="normalizeAudio" type="checkbox" checked>
<span class="smallmuted">Normalize audio (prevent clipping)</span>
</label>
</div>
</div>
<div class="field">
<label class="smallmuted">Video Settings</label>
<div style="display:flex;flex-direction:column;gap:8px">
<label style="display:flex;gap:6px;align-items:center">
<input id="resizeCheckbox" type="checkbox" checked>
<span class="smallmuted">Resize to 720p ‚úÖ</span>
</label>
<div>
<label class="smallmuted">Format:</label>
<div style="display:flex;gap:8px;margin-top:4px">
<label style="display:flex;gap:4px;align-items:center">
<input type="radio" name="format" value="mp4" checked>
<span class="smallmuted">MP4 (recommended) ‚úÖ</span>
</label>
<label style="display:flex;gap:4px;align-items:center">
<input type="radio" name="format" value="webm">
<span class="smallmuted">WebM</span>
</label>
</div>
</div>
</div>
</div>
<div class="field">
<label class="smallmuted">Playback Optimization ‚úÖ</label>
<div style="display:flex;flex-direction:column;gap:6px">
<label style="display:flex;gap:6px;align-items:center">
<input id="hardwareAcceleration" type="checkbox" checked disabled>
<span class="smallmuted">Hardware acceleration (ON)</span>
</label>
<label style="display:flex;gap:6px;align-items:center">
<input id="enableThrottling" type="checkbox" checked disabled>
<span class="smallmuted">Frame throttling @ 30 FPS (ON)</span>
</label>
<label style="display:flex;gap:6px;align-items:center">
<input id="lowLatency" type="checkbox">
<span class="smallmuted">Low latency mode (faster but may skip frames)</span>
</label>
<label style="display:flex;gap:6px;align-items:center">
<input id="useBuffer" type="checkbox" checked disabled>
<span class="smallmuted">Use buffering (ON)</span>
</label>
</div>
</div>
<div class="field">
<label class="smallmuted">Export Settings</label>
<div style="display:flex;flex-direction:column;gap:6px">
<label style="display:flex;gap:6px;align-items:center">
<input id="optimizeExport" type="checkbox" checked>
<span class="smallmuted">Optimize for export (slower but smoother)</span>
</label>
<label style="display:flex;gap:6px;align-items:center">
<input id="addMetadata" type="checkbox" checked>
<span class="smallmuted">Add metadata (‚úÖ correct duration)</span>
</label>
</div>
</div>
<div class="field">
<label class="smallmuted">Downloads</label>
<div id="downloads" class="download-list"><div class="smallmuted">No exports yet.</div></div>
</div>
</div>
<div class="panel">
<p class="smallmuted">‚ú® Performance Boost Active</p>
<ul class="smallmuted">
<li><strong>‚úÖ Frame Throttling</strong> ‚Äî limits draw to 30 FPS (no UI lock)</li>
<li><strong>‚úÖ Hardware Acceleration</strong> ‚Äî uses GPU decoding</li>
<li><strong>‚úÖ 720p Resize</strong> ‚Äî reduces decode load</li>
<li><strong>‚úÖ MP4 + Metadata</strong> ‚Äî exports play correctly everywhere</li>
<li><strong>‚úÖ Buffering + 250ms chunks</strong> ‚Äî smoother recording</li>
</ul>
<p class="smallmuted" style="margin-top:8px;color:#10b981;font-size:11px;">
üöÄ For best results: <strong>use MP4, 720p, and keep clips under 5 min.</strong>
</p>
</div>
</aside>
</div>
<footer class="note">Direct file upload recommended for large or social-media videos.</footer>
</div>
<script>
(function(){
// üöÄ Performance-optimized defaults
let frameCount = 0;
let lastTime = performance.now();
let fps = 0;
let isExporting = false;
let hardwareAccelerationEnabled = true;
let enableThrottling = true;  // ‚úÖ ON by default
let lowLatencyMode = false;
let useBuffer = true;         // ‚úÖ ON by default
let drawFrameRate = 30;       // ‚úÖ 30 FPS throttled

// Elements
const fileInput = document.getElementById('fileInput');
const videoLink = document.getElementById('videoLink');
const loadLinkBtn = document.getElementById('loadLinkBtn');
const player = document.getElementById('player');
const startRange = document.getElementById('startRange');
const endRange = document.getElementById('endRange');
const startInput = document.getElementById('startInput');
const endInput = document.getElementById('endInput');
const manualStart = document.getElementById('manualStart');
const manualEnd = document.getElementById('manualEnd');
const startPercentInput = document.getElementById('startPercentInput');
const endPercentInput = document.getElementById('endPercentInput');
const applyPercentBtn = document.getElementById('applyPercentBtn');
const applyManualTimes = document.getElementById('applyManualTimes');
const currentTimeDisplay = document.getElementById('currentTimeDisplay');
const currentPercentDisplay = document.getElementById('currentPercentDisplay');
const startPercentDisplay = document.getElementById('startPercentDisplay');
const endPercentDisplay = document.getElementById('endPercentDisplay');
const segmentDuration = document.getElementById('segmentDuration');
const segmentPercent = document.getElementById('segmentPercent');
const startPercentText = document.getElementById('startPercentText');
const endPercentText = document.getElementById('endPercentText');
const segmentPercentText = document.getElementById('segmentPercentText');
const segmentIndicator = document.getElementById('segmentIndicator');
const exportProgressInfo = document.getElementById('exportProgressInfo');
const exportProgressPercent = document.getElementById('exportProgressPercent');
const exportProgressTime = document.getElementById('exportProgressTime');
const errorMessage = document.getElementById('errorMessage');
const audioStatus = document.getElementById('audioStatus');
const fileSizeInfo = document.getElementById('fileSizeInfo');
const volumeSlider = document.getElementById('volumeSlider');
const volumeValue = document.getElementById('volumeValue');
const volumePercent = document.getElementById('volumePercent');
const volumeVisualizer = document.getElementById('volumeVisualizer');
const volumePresets = document.querySelectorAll('.volume-preset');
const normalizeAudio = document.getElementById('normalizeAudio');
const generateCaptionsBtn = document.getElementById('generateCaptionsBtn');
const clearCaptionsBtn = document.getElementById('clearCaptionsBtn');
const exportCaptionsBtn = document.getElementById('exportCaptionsBtn');
const captionsPanel = document.getElementById('captionsPanel');
const speedSlider = document.getElementById('speedSlider');
const speedValue = document.getElementById('speedValue');
const speedPercent = document.getElementById('speedPercent');
const speedVisualizer = document.getElementById('speedVisualizer');
const speedPresets = document.querySelectorAll('.speed-preset');
const speedIndicator = document.getElementById('speedIndicator');
const tabButtons = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const previewBtn = document.getElementById('previewBtn');
const trimBtn = document.getElementById('trimBtn');
const progressEl = document.getElementById('progress');
const status = document.getElementById('status');
const downloads = document.getElementById('downloads');
const durationBadge = document.getElementById('durationBadge');
const muteCheckbox = document.getElementById('muteCheckbox');
const resizeCheckbox = document.getElementById('resizeCheckbox');
const formatRadios = document.querySelectorAll('input[name="format"]');
const playPauseBtn = document.getElementById('playPause');
const frameBackBtn = document.getElementById('frameBack');
const frameForwardBtn = document.getElementById('frameForward');
const jumpBack5Btn = document.getElementById('jumpBack5');
const jumpForward5Btn = document.getElementById('jumpForward5');
const setStartBtn = document.getElementById('setStartBtn');
const setEndBtn = document.getElementById('setEndBtn');
const quickJumpButtons = document.querySelectorAll('.jump-btn[data-seconds]');
const percentJumpButtons = document.querySelectorAll('.jump-btn[data-percent]');
const optimizeExportCheckbox = document.getElementById('optimizeExport');
const addMetadataCheckbox = document.getElementById('addMetadata');

// State
let fileURL = null;
let isPlaying = false;
let totalDuration = 0;
let currentFile = null;
let currentVolume = 1.5; // Default 1.5x volume
let currentSpeed = 1.0;
let captions = [];
let isGeneratingCaptions = false;
let speechRecognition = null;

// FPS monitoring
function monitorPerformance() {
  frameCount++;
  const currentTime = performance.now();
  const elapsed = currentTime - lastTime;
  if (elapsed >= 1000) {
    fps = Math.round((frameCount * 1000) / elapsed);
    frameCount = 0;
    lastTime = currentTime;
  }
  requestAnimationFrame(monitorPerformance);
}
requestAnimationFrame(monitorPerformance);

// Tab handling
tabButtons.forEach(button => {
  button.addEventListener('click', () => {
    const tabId = button.dataset.tab;
    tabButtons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    tabContents.forEach(content => {
      content.classList.remove('active');
      if (content.id === tabId) content.classList.add('active');
    });
  });
});

// Time helpers
function formatTime(seconds) {
  if (!isFinite(seconds) || isNaN(seconds)) return '0:00';
  const hrs = Math.floor(seconds / 3600);
  const mins = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  return hrs ? `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}` : `${mins}:${secs.toString().padStart(2, '0')}`;
}
function parseTimeInput(input) {
  if (!input || input.trim() === '') return 0;
  let str = input.trim();
  if (str.includes(':')) {
    const parts = str.split(':');
    let seconds = 0;
    if (parts.length === 3) seconds = parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseFloat(parts[2]);
    else if (parts.length === 2) seconds = parseInt(parts[0]) * 60 + parseFloat(parts[1]);
    return seconds;
  }
  const num = parseFloat(str); return isNaN(num) ? 0 : num;
}
function calculatePercentage(time) {
  return totalDuration > 0 ? Math.min(100, Math.max(0, (time / totalDuration) * 100)) : 0;
}
function formatPercentage(value) { return `${value.toFixed(1)}%`; }
function timeFromPercentage(percent) { return totalDuration ? (percent / 100) * totalDuration : 0; }

function updateAllPercentages() {
  const currentTime = player.currentTime;
  const startTime = parseFloat(startRange.value);
  const endTime = parseFloat(endRange.value);
  const currentPercent = calculatePercentage(currentTime);
  currentPercentDisplay.textContent = formatPercentage(currentPercent);
  const startPercent = calculatePercentage(startTime);
  const endPercent = calculatePercentage(endTime);
  startPercentDisplay.textContent = formatPercentage(startPercent);
  endPercentDisplay.textContent = formatPercentage(endPercent);
  startPercentText.textContent = formatPercentage(startPercent);
  endPercentText.textContent = formatPercentage(endPercent);
  const segmentPercentValue = endPercent - startPercent;
  segmentPercent.textContent = formatPercentage(segmentPercentValue);
  segmentPercentText.textContent = formatPercentage(segmentPercentValue);
  startPercentInput.value = startPercent.toFixed(1);
  endPercentInput.value = endPercent.toFixed(1);
  updateSegmentIndicator();
}
function updateTimeDisplay() {
  currentTimeDisplay.textContent = formatTime(player.currentTime);
  updateAllPercentages();
}
function updateSegmentIndicator() {
  if (totalDuration > 0) {
    const startPercent = calculatePercentage(parseFloat(startRange.value));
    const endPercent = calculatePercentage(parseFloat(endRange.value));
    segmentIndicator.style.setProperty('--start-percent', `${startPercent}%`);
    segmentIndicator.style.setProperty('--end-percent', `${endPercent}%`);
  }
}
function updateSegmentDuration() {
  const start = parseFloat(startRange.value) || 0;
  const end = parseFloat(endRange.value) || 0;
  const duration = end - start;
  segmentDuration.textContent = `${duration.toFixed(2)}s`;
  updateAllPercentages();
}

// Volume & Speed
function updateVolumeDisplay() {
  const volume = parseFloat(volumeSlider.value);
  currentVolume = volume / 100;
  volumeValue.textContent = `${currentVolume.toFixed(1)}x`;
  volumePercent.textContent = `${volume}%`;
  volumeVisualizer.style.setProperty('--volume-percent', `${Math.min(100, volume / 3)}%`);
  volumePresets.forEach(p => p.classList.toggle('active', parseInt(p.dataset.volume) === volume));
}
function updateSpeedDisplay() {
  const speed = parseInt(speedSlider.value);
  currentSpeed = speed / 100;
  speedValue.textContent = `${currentSpeed.toFixed(2)}x`;
  speedPercent.textContent = `${currentSpeed.toFixed(2)}x`;
  speedVisualizer.style.setProperty('--speed-percent', `${Math.min(100, ((speed - 25) / 375) * 100)}%`);
  speedPresets.forEach(p => p.classList.toggle('active', parseInt(p.dataset.speed) === speed));
  player.playbackRate = currentSpeed;
  speedIndicator.textContent = `${currentSpeed.toFixed(2)}x`;
  speedIndicator.classList.add('show');
  setTimeout(() => speedIndicator.classList.remove('show'), 2000);
}
function showError(msg) {
  errorMessage.textContent = msg;
  errorMessage.style.display = 'block';
}
function hideError() { errorMessage.style.display = 'none'; }
function updateAudioStatus(msg, cls = 'ready') {
  audioStatus.textContent = `üîä ${msg}`;
  audioStatus.className = `audio-status ${cls}`;
  audioStatus.style.display = 'flex';
}

// Load from link
loadLinkBtn.addEventListener('click', async () => {
  const url = videoLink.value.trim();
  if (!url) return showError('Enter a video URL');
  try { new URL(url); } catch(e) { return showError('Invalid URL'); }
  status.textContent = 'Loading...';
  hideError();
  try {
    const resp = await fetch(url, { method: 'HEAD' });
    if (!resp.ok) throw new Error('CORS error or video not accessible');
    if (fileURL) URL.revokeObjectURL(fileURL);
    player.src = url;
    player.load();
    currentFile = { name: url.split('/').pop() || 'video', size: 0 };
    fileSizeInfo.textContent = 'From URL';
    tabButtons[0].click();
  } catch (err) {
    console.error(err);
    showError(`Failed to load: ${err.message}`);
    status.textContent = 'Load failed';
  }
});

// File upload
fileInput.addEventListener('change', async ()=>{
  const f = fileInput.files?.[0];
  if (!f) return;
  currentFile = f;
  fileSizeInfo.textContent = `${(f.size / 1024 / 1024).toFixed(1)} MB`;
  if (fileURL) URL.revokeObjectURL(fileURL);
  fileURL = URL.createObjectURL(f);
  player.src = fileURL;
  player.load();
  status.textContent = `Loaded: ${f.name}`;
  downloads.innerHTML = '<div class="smallmuted">No exports yet.</div>';
  isPlaying = false;
  playPauseBtn.textContent = '‚ñ∂';
  clearCaptions();
  updateAudioStatus(`Ready ‚Äî volume: ${currentVolume.toFixed(1)}x`);
  hideError();
});

// Video metadata loaded
player.addEventListener('loadedmetadata', ()=>{
  totalDuration = player.duration || 0;
  startRange.max = endRange.max = totalDuration;
  endRange.value = Math.min(totalDuration, 600);
  durationBadge.textContent = `${Math.floor(totalDuration)}s (${formatTime(totalDuration)})`;
  updateAllPercentages();
  updateSegmentDuration();
  updateAudioStatus(`Ready ‚Äî volume: ${currentVolume.toFixed(1)}x`);
});

// Sync and controls
player.addEventListener('timeupdate', updateTimeDisplay);
player.addEventListener('play', () => { isPlaying = true; playPauseBtn.textContent = '‚è∏'; });
player.addEventListener('pause', () => { isPlaying = false; playPauseBtn.textContent = '‚ñ∂'; });

function syncFromRanges() {
  let s = parseFloat(startRange.value), e = parseFloat(endRange.value);
  if (e < s) { e = s + 0.01; endRange.value = e; }
  startInput.value = formatTime(s);
  endInput.value = formatTime(e);
  manualStart.value = formatTime(s);
  manualEnd.value = formatTime(e);
  updateSegmentDuration();
}
startRange.addEventListener('input', syncFromRanges);
endRange.addEventListener('input', syncFromRanges);

startInput.addEventListener('input', () => {
  const s = Math.max(0, Math.min(totalDuration, parseTimeInput(startInput.value)));
  if (!isNaN(s)) { startRange.value = s; }
});
endInput.addEventListener('input', () => {
  const e = Math.max(0, Math.min(totalDuration, parseTimeInput(endInput.value)));
  if (!isNaN(e)) { endRange.value = e; }
});

applyPercentBtn.addEventListener('click', () => {
  const start = parseFloat(startPercentInput.value);
  const end = parseFloat(endPercentInput.value);
  if (isNaN(start) || isNaN(end) || start < 0 || end > 100 || end <= start) return showError('Invalid % range');
  startRange.value = timeFromPercentage(start);
  endRange.value = timeFromPercentage(end);
  syncFromRanges();
  player.currentTime = parseFloat(startRange.value);
  status.textContent = `Times set: ${start.toFixed(1)}% ‚Üí ${end.toFixed(1)}%`;
});

applyManualTimes.addEventListener('click', () => {
  const s = Math.max(0, Math.min(totalDuration, parseTimeInput(manualStart.value)));
  const e = Math.max(0, Math.min(totalDuration, parseTimeInput(manualEnd.value)));
  if (isNaN(s) || isNaN(e) || e <= s) return showError('Invalid time range');
  startRange.value = s;
  endRange.value = e;
  syncFromRanges();
  player.currentTime = s;
});

// Volume & Speed setup
volumeSlider.addEventListener('input', updateVolumeDisplay);
volumePresets.forEach(p => p.addEventListener('click', () => { volumeSlider.value = p.dataset.volume; updateVolumeDisplay(); }));
speedSlider.addEventListener('input', updateSpeedDisplay);
speedPresets.forEach(p => p.addEventListener('click', () => { speedSlider.value = p.dataset.speed; updateSpeedDisplay(); }));

// Playback controls
playPauseBtn.addEventListener('click', () => player.paused ? player.play() : player.pause());
frameBackBtn.addEventListener('click', () => { player.currentTime = Math.max(0, player.currentTime - 0.1); });
frameForwardBtn.addEventListener('click', () => { player.currentTime = Math.min(totalDuration, player.currentTime + 0.1); });
jumpBack5Btn.addEventListener('click', () => { player.currentTime = Math.max(0, player.currentTime - 5); });
jumpForward5Btn.addEventListener('click', () => { player.currentTime = Math.min(totalDuration, player.currentTime + 5); });
setStartBtn.addEventListener('click', () => { startRange.value = player.currentTime; syncFromRanges(); });
setEndBtn.addEventListener('click', () => { endRange.value = player.currentTime; syncFromRanges(); });

quickJumpButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const sec = parseFloat(btn.dataset.seconds);
    player.currentTime = Math.max(0, Math.min(totalDuration, player.currentTime + sec));
  });
});
percentJumpButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const perc = parseFloat(btn.dataset.percent);
    const newPerc = Math.max(0, Math.min(100, calculatePercentage(player.currentTime) + perc));
    player.currentTime = timeFromPercentage(newPerc);
  });
});

// Keyboard
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  switch (e.key) {
    case ' ': e.preventDefault(); playPauseBtn.click(); break;
    case 'ArrowLeft': e.preventDefault(); frameBackBtn.click(); break;
    case 'ArrowRight': e.preventDefault(); frameForwardBtn.click(); break;
    case 's': case 'S': e.preventDefault(); setStartBtn.click(); break;
    case 'e': case 'E': e.preventDefault(); setEndBtn.click(); break;
    case '[': e.preventDefault(); speedSlider.value = Math.max(25, parseInt(speedSlider.value) - 25); updateSpeedDisplay(); break;
    case ']': e.preventDefault(); speedSlider.value = Math.min(400, parseInt(speedSlider.value) + 25); updateSpeedDisplay(); break;
  }
});

// Preview
previewBtn.addEventListener('click', ()=>{
  if (!player.src) return showError('Load video first');
  const s = parseFloat(startRange.value), e = parseFloat(endRange.value);
  if (e <= s) return showError('End > Start');
  player.currentTime = s;
  player.muted = false;
  player.play();
  const onTime = () => {
    if (player.currentTime >= e - 0.05) {
      player.pause();
      player.removeEventListener('timeupdate', onTime);
      status.textContent = 'Preview finished.';
    }
  };
  player.addEventListener('timeupdate', onTime);
});

// Captions
function clearCaptions() { captions = []; updateCaptionsDisplay(); }
function updateCaptionsDisplay() {
  captionsPanel.innerHTML = captions.length
    ? captions.map((c, i) => `<div class="caption-line"><span class="caption-time">${formatTime(c.start)} ‚Üí ${formatTime(c.end)}</span><span class="caption-text">${c.text}</span></div>`).join('')
    : '<div class="no-captions">No captions generated yet.</div>';
}

async function generateCaptions() {
  if (!player.src) return showError('Load video first');
  if (isGeneratingCaptions) return showError('Already generating');
  if (!('webkitSpeechRecognition' in window)) return showError('Speech recognition not supported ‚Äî use Chrome/Edge');
  
  isGeneratingCaptions = true;
  generateCaptionsBtn.textContent = 'Generating...';
  generateCaptionsBtn.disabled = true;
  clearCaptionsBtn.disabled = true;
  captionsPanel.innerHTML = '<div class="no-captions">Starting...</div>';
  
  try {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    speechRecognition = new SpeechRecognition();
    speechRecognition.continuous = true;
    speechRecognition.interimResults = false;
    speechRecognition.lang = 'en-US';
    
    let currentCaption = { text: '', start: 0, end: 0 };
    let isCaptionActive = false;
    
    speechRecognition.onresult = e => {
      const currentTime = player.currentTime;
      const transcript = Array.from(e.results).map(r => r[0].transcript).join(' ');
      if (!isCaptionActive) { currentCaption.start = Math.max(0, currentTime - 2); isCaptionActive = true; }
      currentCaption.text = transcript;
      currentCaption.end = currentTime;
      if (captions.length) captions[captions.length - 1] = {...currentCaption};
      else captions.push({...currentCaption});
      updateCaptionsDisplay();
    };
    
    speechRecognition.onend = () => {
      if (isCaptionActive && captions.length) captions[captions.length - 1].end = player.currentTime;
      updateCaptionsDisplay();
      isGeneratingCaptions = false;
      generateCaptionsBtn.textContent = '‚úÖ Done';
      generateCaptionsBtn.disabled = false;
      clearCaptionsBtn.disabled = false;
    };
    
    speechRecognition.onerror = e => {
      isGeneratingCaptions = false;
      generateCaptionsBtn.textContent = '‚ùå Failed';
      generateCaptionsBtn.disabled = false;
      clearCaptionsBtn.disabled = false;
      showError(`Caption error: ${e.error}`);
    };
    
    player.currentTime = 0;
    await player.play();
    speechRecognition.start();
    
    setTimeout(() => {
      if (isGeneratingCaptions) speechRecognition.stop();
    }, Math.min(totalDuration * 1000, 120000));
  } catch (err) {
    isGeneratingCaptions = false;
    generateCaptionsBtn.textContent = '‚ùå Failed';
    showError(`Error: ${err.message}`);
  }
}

function exportCaptionsAsSRT() {
  if (!captions.length) return showError('No captions');
  let srt = '';
  captions.forEach((c, i) => {
    const fmt = s => {
      const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = Math.floor(s % 60), ms = Math.floor((s % 1) * 1000);
      return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')},${ms.toString().padStart(3,'0')}`;
    };
    srt += `${i + 1}
${fmt(c.start)} --> ${fmt(c.end)}
${c.text}

`;
  });
  const blob = new Blob([srt], { type: 'text/plain' });
  const a = document.createElement('a');
  const name = (currentFile?.name?.replace(/\.[^\.]+$/, '') || 'video') + '_captions.srt';
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  status.textContent = `Exported ${captions.length} lines as SRT`;
}

generateCaptionsBtn.addEventListener('click', generateCaptions);
clearCaptionsBtn.addEventListener('click', clearCaptions);
exportCaptionsBtn.addEventListener('click', exportCaptionsAsSRT);

// üöÄ Optimized export (anti-freeze)
function throttledDrawFrame(vid, canvas, ctx, s, e, progressEl, exportProgressPercent, exportProgressTime, onComplete) {
  let rafId = null;
  const frameInterval = 1000 / drawFrameRate;
  let lastFrameTime = 0;
  
  function draw(currentTime) {
    if (enableThrottling && (currentTime - lastFrameTime) < frameInterval) return rafId = requestAnimationFrame(draw);
    lastFrameTime = currentTime;
    const vt = vid.currentTime;
    if (vid.videoWidth && vid.readyState >= 2) {
      if (canvas.width !== vid.videoWidth || canvas.height !== vid.videoHeight) {
        canvas.width = vid.videoWidth;
        canvas.height = vid.videoHeight;
      }
      ctx.drawImage(vid, 0, 0, vid.videoWidth, vid.videoHeight);
    }
    const progress = (vt - s) / (e - s);
    const pct = Math.min(100, Math.max(0, progress * 100));
    progressEl.value = progress;
    exportProgressPercent.textContent = `${pct.toFixed(1)}%`;
    exportProgressTime.textContent = `${formatTime(vt - s)} / ${formatTime(e - s)}`;
    if (vt >= e - 0.05) {
      cancelAnimationFrame(rafId);
      if (onComplete) onComplete();
    } else rafId = requestAnimationFrame(draw);
  }
  rafId = requestAnimationFrame(draw);
  return rafId;
}

async function createMediaStreamWithVolume(videoElement, options = {}) {
  const { mute = false, resize = false, volume = 1.0, normalize = true } = options;
  const naturalW = videoElement.videoWidth || 640;
  const naturalH = videoElement.videoHeight || 360;
  const targetW = resize ? 1280 : naturalW;
  const targetH = resize ? 720 : naturalH;

  const canvas = document.createElement('canvas');
  canvas.width = targetW;
  canvas.height = targetH;
  const ctx = canvas.getContext('2d', { alpha: false });

  const videoStream = canvas.captureStream(drawFrameRate);
  const videoTrack = videoStream.getVideoTracks()[0];

  if (mute) return { mediaStream: new MediaStream([videoTrack]), canvas, ctx };

  try {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: lowLatencyMode ? 'playback' : 'interactive' });
    const source = audioCtx.createMediaElementSource(videoElement);
    const gain = audioCtx.createGain();
    gain.gain.value = volume;
    if (normalize && volume > 1) {
      const comp = audioCtx.createDynamicsCompressor();
      comp.threshold.value = -24; comp.ratio.value = 12;
      source.connect(gain); gain.connect(comp); comp.connect(audioCtx.destination);
    } else { source.connect(gain); gain.connect(audioCtx.destination); }
    const dest = audioCtx.createMediaStreamDestination();
    gain.connect(dest);
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    const audioTrack = dest.stream.getAudioTracks()[0];
    if (audioTrack) {
      const stream = new MediaStream([videoTrack, audioTrack]);
      videoElement._audioContext = audioCtx;
      return { mediaStream: stream, canvas, ctx };
    }
  } catch (err) { console.warn('Audio fallback:', err); }
  return { mediaStream: new MediaStream([videoTrack]), canvas, ctx };
}

function getSelectedFormat() {
  return document.querySelector('input[name="format"]:checked')?.value || 'mp4';
}

function createMediaRecorder(stream) {
  const format = getSelectedFormat();
  const hasAudio = stream.getAudioTracks().length > 0;
  const optimize = optimizeExportCheckbox.checked;
  const videoBps = optimize ? 5000000 : 2500000;
  
  const tryTypes = mimeTypes => mimeTypes.find(type => MediaRecorder.isTypeSupported(type));
  
  if (format === 'mp4') {
    const best = tryTypes([
      'video/mp4;codecs="avc1.640028,mp4a.40.2"',
      'video/mp4;codecs="avc1.42E01E,mp4a.40.2"',
      'video/mp4;codecs="avc1.42E01E"',
      'video/mp4'
    ]);
    return new MediaRecorder(stream, best ? { mimeType: best, videoBitsPerSecond: videoBps } : { videoBitsPerSecond: videoBps });
  } else {
    const best = tryTypes([
      'video/webm;codecs="vp9,opus"',
      'video/webm;codecs="vp8,opus"',
      'video/webm'
    ]);
    return new MediaRecorder(stream, best ? { mimeType: best, videoBitsPerSecond: videoBps } : { videoBitsPerSecond: videoBps });
  }
}

trimBtn.addEventListener('click', async ()=>{
  if (!player.src) return showError('Load video first');
  const s = parseFloat(startRange.value), e = parseFloat(endRange.value);
  if (e <= s) return showError('End > Start');

  const exportLen = e - s;
  trimBtn.disabled = true;
  previewBtn.disabled = true;
  fileInput.disabled = true;
  progressEl.style.display = 'block';
  exportProgressInfo.style.display = 'flex';
  isExporting = true;

  try {
    const vid = document.createElement('video');
    vid.src = player.src;
    vid.crossOrigin = 'anonymous';
    vid.playsInline = true;
    vid.preload = 'auto';
    
    await new Promise((resolve, reject) => {
      const to = setTimeout(() => reject(new Error('Timeout')), 10000);
      vid.onloadedmetadata = () => { clearTimeout(to); resolve(); };
      vid.onerror = reject;
    });

    vid.currentTime = s;
    await new Promise(r => { vid.onseeked = r; });

    const { mediaStream, canvas, ctx } = await createMediaStreamWithVolume(vid, {
      mute: muteCheckbox.checked,
      resize: resizeCheckbox.checked,
      volume: currentVolume,
      normalize: normalizeAudio.checked && currentVolume > 1
    });

    const recorder = createMediaRecorder(mediaStream);
    const chunks = [];
    recorder.ondataavailable = e => e.data.size && chunks.push(e.data);
    recorder.onstop = async () => {
      try {
        const mimeType = getSelectedFormat() === 'mp4' ? 'video/mp4' : 'video/webm';
        let blob = new Blob(chunks, { type: mimeType });
        if (!blob.size) throw new Error('Empty export');

        const url = URL.createObjectURL(blob);
        const baseName = (currentFile?.name?.replace(/\.[^\.]+$/, '') || 'video');
        const ext = getSelectedFormat() === 'mp4' ? 'mp4' : 'webm';
        const filename = `${baseName}_${formatTime(s).replace(/[:]/g,'-')}_to_${formatTime(e).replace(/[:]/g,'-')}.${ext}`;
        
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
        a.innerHTML = `<span>${filename} (${sizeMB} MB)</span><div style="display:flex;align-items:center;gap:2px"><span style="font-size:11px;padding:1px 4px;border-radius:4px;background:var(--accent);color:white;">${ext.toUpperCase()}</span> <span style="font-size:10px;color:#10b981;">üìä‚ö°</span></div>`;
        a.className = 'download';
        downloads.prepend(a);
        status.textContent = `‚úÖ Export ready (${sizeMB} MB) ‚Äî with metadata & anti-freeze`;
      } catch (err) {
        showError(`Export error: ${err.message}`);
        status.textContent = 'Export failed';
      } finally {
        cleanup();
      }
    };
    recorder.onerror = err => { showError(`Recording error: ${err.message}`); cleanup(); };
    
    recorder.start(250); // 250ms chunks ‚Üí smoother
    status.textContent = `Recording ${formatTime(s)} ‚Üí ${formatTime(e)}...`;
    await vid.play().catch(() => { vid.muted = true; vid.play(); });
    throttledDrawFrame(vid, canvas, ctx, s, e, progressEl, exportProgressPercent, exportProgressTime, () => {
      recorder.stop(); vid.pause();
    });

    function cleanup() {
      progressEl.style.display = 'none';
      exportProgressInfo.style.display = 'none';
      trimBtn.disabled = false;
      previewBtn.disabled = false;
      fileInput.disabled = false;
      isExporting = false;
      if (vid._audioContext) vid._audioContext.close().catch(()=>{});
    }
  } catch (err) {
    console.error('Export failed:', err);
    showError(`Export error: ${err.message}`);
    trimBtn.disabled = false;
    previewBtn.disabled = false;
    fileInput.disabled = false;
    progressEl.style.display = 'none';
    exportProgressInfo.style.display = 'none';
    isExporting = false;
  }
});

// Init
updateVolumeDisplay();
updateSpeedDisplay();
player.classList.add('smooth');
document.querySelector('input[value="mp4"]').checked = true;
resizeCheckbox.checked = true;
optimizeExportCheckbox.checked = true;
addMetadataCheckbox.checked = true;
})();
</script>
</body>
</html>